name: Deploy Backend to Lambda

on:
  push:
    branches: [main]
  workflow_dispatch:  # Allow manual deployment

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    uses: ajnacloud-ksj/ajna-github-workflows/.github/workflows/reusable-lambda.yml@main
    with:
      # AWS Configuration
      aws-region: 'ap-south-1'
      
      # ECR Repository name (will be created if doesn't exist)
      ecr-repository: 'nutriwealth-backend'
      
      # Lambda function name (must exist in AWS Lambda)
      lambda-function-name: 'ajna_nutri_wealth_backend_v2'
      
      # Lambda Configuration
      timeout: 300  # 5 minutes for AI processing
      memory-size: 1024  # 1GB for better performance
      
      # Environment Variables (non-sensitive)
      environment-variables: "AUTH_MODE=cognito,ENABLE_LAMBDA_ASYNC=true,IBEX_LAMBDA_NAME=${{ vars.IBEX_LAMBDA_NAME }},IBEX_API_URL=${{ vars.IBEX_API_URL }}"
      
      # Working directory (where Dockerfile is located)
      working-directory: '.'
    secrets:
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}
      COGNITO_USER_POOL_ID: ${{ secrets.COGNITO_USER_POOL_ID }}
      COGNITO_CLIENT_ID: ${{ secrets.COGNITO_CLIENT_ID }}
      IBEX_API_KEY: ${{ secrets.IBEX_API_KEY }}
