name: Deploy Backend to Lambda

on:
  push:
    branches: [main]
  workflow_dispatch:  # Allow manual deployment

permissions:
  id-token: write
  contents: read

jobs:
  build-and-push:
    uses: ajnacloud-ksj/ajna-github-workflows/.github/workflows/reusable-docker-ecr.yml@main
    with:
      aws-region: ap-south-1
      ecr-repository: nutriwealth-backend
      role-to-assume: arn:aws:iam::808527335982:role/GitHubActions-Deploy-Role
      image-tag: ${{ github.sha }}
      platform: linux/arm64
    secrets: inherit

  deploy-lambda:
    needs: build-and-push
    uses: ajnacloud-ksj/ajna-github-workflows/.github/workflows/reusable-lambda-deploy.yml@main
    with:
      aws-region: ap-south-1
      lambda-function-name: ajna_nutri_wealth_backend_v2
      image-uri: ${{ needs.build-and-push.outputs.image-uri }}
      role-to-assume: arn:aws:iam::808527335982:role/GitHubActions-Deploy-Role
      # Base environment variables (secrets will be set in next job)
      environment-variables: "AUTH_MODE=cognito,ENABLE_LAMBDA_ASYNC=false,ENABLE_SQS=true,ANALYSIS_QUEUE_URL=${{ vars.ANALYSIS_QUEUE_URL }},ANALYSIS_DLQ_URL=${{ vars.ANALYSIS_DLQ_URL }},IBEX_LAMBDA_NAME=${{ vars.IBEX_LAMBDA_NAME }},IBEX_API_URL=${{ vars.IBEX_API_URL }},COGNITO_REGION=ap-south-1,COGNITO_USER_POOL_ID=${{ vars.COGNITO_USER_POOL_ID }},COGNITO_CLIENT_ID=${{ vars.COGNITO_CLIENT_ID }}"
    secrets: inherit

  configure-api-keys:
    name: Configure API Keys
    needs: deploy-lambda
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: arn:aws:iam::808527335982:role/GitHubActions-Deploy-Role
          aws-region: ap-south-1

      - name: Validate required secrets
        run: |
          echo "Validating required GitHub secrets..."

          MISSING_SECRETS=""

          if [ -z "${{ secrets.OPENAI_API_KEY }}" ]; then
            echo "‚ùå ERROR: OPENAI_API_KEY secret is not configured in GitHub"
            MISSING_SECRETS="${MISSING_SECRETS}OPENAI_API_KEY "
          else
            echo "‚úÖ OPENAI_API_KEY is configured"
          fi

          if [ -z "${{ secrets.GROQ_API_KEY }}" ]; then
            echo "‚ùå ERROR: GROQ_API_KEY secret is not configured in GitHub"
            MISSING_SECRETS="${MISSING_SECRETS}GROQ_API_KEY "
          else
            echo "‚úÖ GROQ_API_KEY is configured"
          fi

          if [ -z "${{ secrets.IBEX_API_KEY }}" ]; then
            echo "‚ùå ERROR: IBEX_API_KEY secret is not configured in GitHub"
            MISSING_SECRETS="${MISSING_SECRETS}IBEX_API_KEY "
          else
            echo "‚úÖ IBEX_API_KEY is configured"
          fi

          if [ -n "$MISSING_SECRETS" ]; then
            echo ""
            echo "üö® DEPLOYMENT FAILED: Required secrets are missing"
            echo "Missing secrets: $MISSING_SECRETS"
            echo ""
            echo "To fix this:"
            echo "1. Go to: https://github.com/ajnacloud-ksj/ajna_nutri_wealth_backend_v2/settings/secrets/actions"
            echo "2. Click 'New repository secret' for each missing secret"
            echo "3. Add the API keys with the exact names shown above"
            echo ""
            exit 1
          fi

          echo "‚úÖ All required secrets are configured"

      - name: Update Lambda environment variables with API keys
        run: |
          echo "Configuring Lambda with API keys from GitHub secrets..."

          # Get current environment variables (for non-secret vars)
          CURRENT_ENV=$(aws lambda get-function-configuration \
            --function-name ajna_nutri_wealth_backend_v2 \
            --query 'Environment.Variables' \
            --output json || echo '{}')

          # Update with secrets from GitHub (single source of truth)
          UPDATED_ENV=$(echo "$CURRENT_ENV" | jq \
            --arg openai "${{ secrets.OPENAI_API_KEY }}" \
            --arg groq "${{ secrets.GROQ_API_KEY }}" \
            --arg ibex "${{ secrets.IBEX_API_KEY }}" \
            '. + {
              "OPENAI_API_KEY": $openai,
              "GROQ_API_KEY": $groq,
              "IBEX_API_KEY": $ibex
            }')

          # Write to file to avoid shell escaping issues
          echo "$UPDATED_ENV" > /tmp/env_vars.json

          # Update Lambda configuration
          aws lambda update-function-configuration \
            --function-name ajna_nutri_wealth_backend_v2 \
            --cli-input-json "{\"Environment\": {\"Variables\": $(cat /tmp/env_vars.json)}}" \
            --output json > /dev/null

          echo "‚úÖ Lambda configured with API keys from GitHub secrets"

  configure-sqs-trigger:
    name: Configure SQS Trigger for Async Processing
    needs: configure-api-keys
    runs-on: ubuntu-latest

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: arn:aws:iam::808527335982:role/GitHubActions-Deploy-Role
          aws-region: ap-south-1

      - name: Check for existing SQS trigger
        id: check-trigger
        run: |
          echo "Checking for existing SQS event source mapping..."
          EXISTING_UUID=$(aws lambda list-event-source-mappings \
            --function-name ajna_nutri_wealth_backend_v2 \
            --region ap-south-1 \
            --query "EventSourceMappings[?contains(EventSourceArn,'nutriwealth-analysis-queue')].UUID" \
            --output text || echo "")

          echo "existing_uuid=$EXISTING_UUID" >> $GITHUB_OUTPUT

          if [ -n "$EXISTING_UUID" ]; then
            echo "Found existing mapping: $EXISTING_UUID"
          else
            echo "No existing mapping found"
          fi

      - name: Create or update SQS trigger
        run: |
          if [ -n "${{ steps.check-trigger.outputs.existing_uuid }}" ]; then
            echo "Updating existing SQS trigger..."
            aws lambda update-event-source-mapping \
              --uuid "${{ steps.check-trigger.outputs.existing_uuid }}" \
              --enabled \
              --batch-size 10 \
              --maximum-batching-window-in-seconds 0 \
              --region ap-south-1
            echo "‚úÖ Updated existing SQS trigger"
          else
            echo "Creating new SQS trigger..."
            aws lambda create-event-source-mapping \
              --function-name ajna_nutri_wealth_backend_v2 \
              --event-source-arn arn:aws:sqs:ap-south-1:808527335982:nutriwealth-analysis-queue \
              --batch-size 10 \
              --maximum-batching-window-in-seconds 0 \
              --region ap-south-1
            echo "‚úÖ Created new SQS trigger"
          fi

      - name: Verify SQS trigger configuration
        run: |
          echo "Verifying SQS trigger configuration..."

          # Wait for trigger to be enabled (handles "Updating" state)
          MAX_ATTEMPTS=30  # 30 attempts * 2 seconds = 60 seconds max
          ATTEMPT=0

          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            # Get current state
            STATE=$(aws lambda list-event-source-mappings \
              --function-name ajna_nutri_wealth_backend_v2 \
              --region ap-south-1 \
              --query "EventSourceMappings[?contains(EventSourceArn,'nutriwealth-analysis-queue')].State" \
              --output text)

            echo "Attempt $((ATTEMPT + 1))/$MAX_ATTEMPTS: Trigger state is '$STATE'"

            if [ "$STATE" = "Enabled" ]; then
              echo "‚úÖ SQS trigger is enabled and ready for async processing!"

              # Show final configuration
              aws lambda list-event-source-mappings \
                --function-name ajna_nutri_wealth_backend_v2 \
                --region ap-south-1 \
                --query "EventSourceMappings[?contains(EventSourceArn,'nutriwealth-analysis-queue')].{State:State,BatchSize:BatchSize,EventSourceArn:EventSourceArn}" \
                --output table

              exit 0
            elif [ "$STATE" = "Enabling" ] || [ "$STATE" = "Updating" ]; then
              echo "‚è≥ Trigger is in transitional state, waiting..."
              sleep 2
            elif [ -z "$STATE" ]; then
              echo "‚ùå ERROR: No SQS trigger found!"
              exit 1
            else
              echo "‚ùå ERROR: Unexpected trigger state: $STATE"
              exit 1
            fi

            ATTEMPT=$((ATTEMPT + 1))
          done

          echo "‚ùå ERROR: Timeout waiting for SQS trigger to be enabled (stuck in state: $STATE)"
          exit 1
